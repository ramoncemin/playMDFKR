<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <label for="videoHandler">Handler</label>
    <input type="text" id="videoHandler" required minlength="11" maxlength="11" size="11"><br> <br> 
    <label for="language">Language</label>
    <input type="text" id="language" required minlength="2" maxlength="2" size="2" value="fr"><br> <br>     
    <div id="player"></div><br> <br> 
    <button id='btnNext'>Next</button>

    <script>
        let player;
        var seekSteps = 10, seekToSecs = 0;
        var bPlayBackWithCC = true;
        var language = document.getElementById('language');
        var btnNext = document.getElementById('btnNext');
        var videoHandler = document.getElementById('videoHandler');
        var playBackRates = [/*0.25, 0.5, */0.75, 1, /*1.25, 1.5, 1.75, 2*/];
        var indexPlayBackRates = 0;

        document.onkeyup = function(e) {
            if (e.which == 78) {
                playMDFKR();
            } 
        };        

        btnNext.addEventListener('click', function (event) {
            playMDFKR();
        }, false);

        function playMDFKR(){
            player.setPlaybackRate(playBackRates[indexPlayBackRates]);
            //console.log('indexPlayBackRates=' + indexPlayBackRates);

            if(bPlayBackWithCC){
                playBackWithCC();
            }else{
                playBackWithoutCC();
            }
        }
            
//todo fim de video zera variÃ¡veis do play
//todo fazer um dicionario com o par velocidade e tipo de playback(com ou sem legenda)
//tipo playBackRates = 0.75/Sub, 1/Sub e 1/Without Sub

        const tag = document.createElement('script')
        tag.src = 'https://www.youtube.com/iframe_api'
        const firstScriptTag = document.getElementsByTagName('script')[0]
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)

        const onApiChange = _ => {   
        if (typeof player.setOption === 'function' && !bPlayBackWithCC) {
            player.setOption('captions', 'track', {languageCode: language.value});
            //alert(0);
        }  
        
        }
        //https://youtube.com/get_video_info?video_id=abcfQpQSU7s
        //https://video.google.com/timedtext?lang=pt&v=abcfQpQSU7s
        const onReady = _ => {       
            //alert(0);
        //playBackWithCC();  
        //player.setOption('captions', 'track', {languageCode: 'fr'});

        }

        function onYouTubePlayerAPIReady() {
        player = new YT.Player('player', {
                                height: '360',
                                width: '640',
                                videoId: '',
                                playerVars: {
                                cc_load_policy: 1,
                                //controls: 0
                                },
                                events: {onReady,
                                     onApiChange
                                }
                    })
        }

        function playBackWithCC(){
            console.log('playBackWithCC=' + seekToSecs);    
            //player.setPlaybackRate(0.75);
            //player.loadModule("captions");  //Works for html5 ignored by AS3
            //player.loadModule("cc");  //Works for AS3 ignored by html5     
            player.loadVideoById({'videoId': videoHandler.value,
                    'startSeconds': seekToSecs - 0.5,
                    'endSeconds': seekToSecs + seekSteps});
            bPlayBackWithCC = false;
            //player.setOption('captions', 'track', {languageCode: 'fr'})               
            //player.seekTo(seekToSecs);    
            //player.playVideo();
            //setTimeout(playBackWithoutCC, seekSteps*1000);
            //player.pauseVideo();    
        }

        function playBackWithoutCC(){                
            console.log('playBackWithoutCC=' + seekToSecs);
            player.unloadModule("captions");  //Works for html5 ignored by AS3
            player.unloadModule("cc");  //Works for AS3 ignored by html5     
            
            //waitSeconds(3000);

            //player.setPlaybackRate(0.75);
            player.loadVideoById({'videoId': videoHandler.value,
                    'startSeconds': seekToSecs - 0.5,
                    'endSeconds': seekToSecs + seekSteps});
            bPlayBackWithCC = true;
            //player.seekTo(seekToSecs);
            //player.playVideo();
            //setTimeout(playBackWithCC, seekSteps*1000);
            //player.pauseVideo();    
            if(indexPlayBackRates >= playBackRates.length - 1){
                seekToSecs += seekSteps;
                indexPlayBackRates = 0;
                //console.log('indexPlayBackRates = 0');
            }else{
                indexPlayBackRates++;         
            }
            
            //console.log('indexPlayBackRates=' + indexPlayBackRates);
        }

        /*function waitSeconds(iMilliSeconds) {
            var counter= 0
                , start = new Date().getTime()
                , end = 0;
            while (counter < iMilliSeconds) {
                end = new Date().getTime();
                counter = end - start;
            }
        }

        function playMDFKR(){
            //while(player.getPlayerState() != 0){
                playBackWithCC();

                //playBackWithoutCC();
            //}
        }*/



        /*
        --with captions
        player.loadModule("captions");  //Works for html5 ignored by AS3
        player.loadModule("cc");  //Works for AS3 ignored by html5    
        player.setOption('captions', 'track', {languageCode: 'fr'})
        player.setPlaybackRate(0.75);
        player.loadVideoById({'videoId': 'bRLWRS5I0To',
                    'startSeconds': 5,
                    'endSeconds': 100});
                

        --without captions
        
        player.setOption('');
        player.setPlaybackRate(0.75);
        player.seekTo(5);
        player.unloadModule("captions");  //Works for html5 ignored by AS3
        player.unloadModule("cc");  //Works for AS3 ignored by html5 
        */

    </script>
  </body>
</html>


