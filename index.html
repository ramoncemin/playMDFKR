<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PlayMDFKR 1.4</title>
  </head>
  <body>
    
    <label for="videoHandler">Handler</label>
    <input type="text" id="videoHandler" required minlength="11" maxlength="11" size="11" value="qAPp_MMP3pI"><br> <br> 
    <label for="language">Language</label>
    <input type="text" id="language" required minlength="2" maxlength="2" size="2" value="fr"><br> <br>

    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div><br> <br> 

    <div>
        <button id='btnNext'>Next</button>
        <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> 
    </div>

    <script>                    
        //1. todo fim de video zera variáveis do play
        //2. todo fazer o video tocar em sequência sem precisar apertar next e o pause do usuário não atrapalhar o fluxo

        let player;

        const tag = document.createElement('script');
        const firstScriptTag = document.getElementsByTagName('script')[0];
        
        tag.src = 'https://www.youtube.com/iframe_api';
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var seekSteps = 60, seekToSecs = 0;
        var language = document.getElementById('language');
        var btnNext = document.getElementById('btnNext');
        var videoHandler = document.getElementById('videoHandler');
        var playBackRates = [{speed:0.75, captions:true},{speed:1, captions:true},{speed:1, captions:false}];
        var indexPlayBackRates = 0;
        var bPlayIniatedByScript = false;

        document.onkeyup = function(e) {
            if (e.which == 78) {//'N'
                playMDFKR();
            } 
        };        

        btnNext.addEventListener('click', function (event) {
            playMDFKR();
        }, false);

        function playMDFKR(){
            bPlayIniatedByScript = true;
            //console.log('playBackRates[' + indexPlayBackRates + '].captions=' + playBackRates[indexPlayBackRates].captions + ' seekToSecs=' + seekToSecs);
            player.setPlaybackRate(playBackRates[indexPlayBackRates].speed);
            player.loadVideoById({'videoId': videoHandler.value,
                                  'startSeconds': seekToSecs - 1,
                                  'endSeconds': seekToSecs + seekSteps + 1});   

        }

        const onApiChange = _ => {   
            console.log('playBackRates[' + indexPlayBackRates + '].captions=' + playBackRates[indexPlayBackRates].captions);
            
            if (typeof player.setOption === 'function' && playBackRates[indexPlayBackRates].captions) {
                //alert(0);
                //player.setOption('captions', 'track', {languageCode: language.value});
            }          
        }


        const onStateChange = _ => {
            if(player.getPlayerState() === 1 && bPlayIniatedByScript){
                bPlayIniatedByScript = false;
                if (typeof player.setOption === 'function' && !playBackRates[indexPlayBackRates].captions) {
                    player.unloadModule("captions");  //Works for html5 ignored by AS3
                    player.unloadModule("cc");  //Works for AS3 ignored by html5  
                }  

                if(indexPlayBackRates >= playBackRates.length - 1){
                    seekToSecs += seekSteps;
                    indexPlayBackRates = 0;
                }else{      
                    indexPlayBackRates++;         
                } 
            }

        }

        /*
        const onReady = _ => {       

        }
        */

        function onYouTubePlayerAPIReady() {
            player = new YT.Player('player', {height: '360',
                                              width: '640',
                                              videoId: '',
 
                                              playerVars: {
                                                //cc_load_policy: 1,
                                                fs: 0,
                                                controls: 0,
                                                //iv_load_policy: 3,
                                                //modestbranding: 1,
                                              },
                                              events: {//onReady,
                                                  onApiChange,
                                                  onStateChange
                                              }
                    })
        }

    </script>
  </body>
</html>


